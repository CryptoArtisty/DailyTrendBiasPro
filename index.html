<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bias Messenger - Privacy-First Trading Alerts</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Privacy Banner */
        .privacy-banner {
            background: rgba(0, 150, 136, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid #009688;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .privacy-banner-icon {
            font-size: 48px;
            background: #009688;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .privacy-banner-content {
            flex: 1;
        }

        .privacy-banner-title {
            font-size: 24px;
            font-weight: bold;
            color: #009688;
            margin-bottom: 10px;
        }

        .privacy-banner-text {
            line-height: 1.6;
            opacity: 0.9;
        }

        .privacy-badge {
            background: #009688;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }

        /* Main Header */
        .app-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .app-logo {
            font-size: 40px;
        }

        .app-title {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-left: auto;
        }

        /* Timer Panel */
        .timer-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #status {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        #next-candle-timer {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: bold;
            color: #FFD700;
            border: 1px solid #FFD700;
        }

        /* Price Summary Panel */
        .price-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .price-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .price-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .price-value {
            font-size: 24px;
            font-weight: bold;
        }

        .price-value.highlight {
            color: #FFD700;
            font-size: 28px;
        }

        .position-tag {
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tag-bullish {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }

        .tag-neutral {
            background: linear-gradient(135deg, #FFC107, #FF8F00);
            color: #333;
        }

        .tag-bearish {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: white;
        }

        /* Telegram Connect Section */
        .telegram-section {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #009688;
        }

        .telegram-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .telegram-icon {
            font-size: 32px;
        }

        .telegram-title {
            font-size: 20px;
            font-weight: bold;
            color: #009688;
        }

        .telegram-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .connection-step {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #009688;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .step-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .step-description {
            font-size: 14px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        .bot-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .bot-button:hover {
            background: #006699;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3);
        }

        .connection-status {
            background: rgba(0, 150, 136, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.connected {
            background: #4CAF50;
            color: white;
        }

        .status-badge.disconnected {
            background: #f44336;
            color: white;
        }

        .status-badge.pending {
            background: #FFC107;
            color: #333;
        }

        .connection-id {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Tab Navigation */
        .tab-container {
            margin: 20px 0;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .tab-button {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0 0 12px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .asset-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .asset-card.bullish {
            border-left-color: #4CAF50;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(46, 125, 80, 0.1));
        }

        .asset-card.neutral {
            border-left-color: #FFC107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 143, 0, 0.1));
        }

        .asset-card.bearish {
            border-left-color: #f44336;
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(198, 40, 40, 0.1));
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .asset-name {
            font-weight: bold;
            font-size: 16px;
        }

        .asset-price {
            font-weight: bold;
            color: #FFD700;
        }

        .asset-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin-top: 10px;
        }

        .asset-ema {
            color: #FFD700;
            opacity: 0.9;
        }

        .asset-position {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* Timeframe Table */
        .timeframe-table {
            width: 100%;
            border-collapse: collapse;
            color: white;
        }

        .timeframe-table th {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            text-align: left;
            color: #FFD700;
            font-weight: bold;
        }

        .timeframe-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeframe-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .timeframe-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group select,
        .control-group input,
        .control-group button {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 13px;
        }

        .control-group button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .control-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Threshold Slider */
        .threshold-container {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }

        .threshold-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #f44336);
            border-radius: 10px;
            outline: none;
        }

        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #FFD700;
        }

        .threshold-value {
            font-weight: bold;
            color: #FFD700;
            min-width: 60px;
            text-align: right;
        }

        /* Chart Container */
        #chart-container {
            width: 100%;
            height: 400px;
            background: #1a1a2e;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Signal History */
        #signal-history {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .alert-touch {
            color: #FFD700;
            border-left: 3px solid #FFD700;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 215, 0, 0.1);
            font-size: 13px;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .privacy-banner {
                flex-direction: column;
                text-align: center;
            }

            .price-panel {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Privacy Banner -->
        <div class="privacy-banner">
            <div class="privacy-banner-icon">üîê</div>
            <div class="privacy-banner-content">
                <div class="privacy-banner-title">Zero-Knowledge Privacy Architecture</div>
                <div class="privacy-banner-text">
                    <span class="privacy-badge">No Server Storage</span>
                    <span class="privacy-badge">End-to-End Encrypted</span>
                    <span class="privacy-badge">Open Source</span>
                    <br><br>
                    Your Chat ID <strong>never leaves your device</strong>. All alerts go directly from your browser to Telegram.
                    The developer cannot see your Chat ID, trading activity, or personal information.
                </div>
            </div>
        </div>

        <!-- App Header -->
        <div class="app-header">
            <span class="app-logo">üìà</span>
            <span class="app-title">Trading Bias Messenger</span>
            <span class="app-subtitle">Privacy-First Trading Alerts</span>
        </div>

        <!-- Timer Panel -->
        <div class="timer-panel">
            <div id="status">Initializing...</div>
            <div id="next-candle-timer">Next candle: --:--</div>
        </div>

        <!-- Price Summary Panel -->
        <div class="price-panel">
            <div class="price-item">
                <span class="price-label">Asset</span>
                <span class="price-value highlight" id="current-asset">PAXG/Gold</span>
            </div>
            <div class="price-item">
                <span class="price-label">Price</span>
                <span class="price-value highlight" id="current-price">--</span>
            </div>
            <div class="price-item">
                <span class="price-label">EMA <span id="ema-period-display">350</span></span>
                <span class="price-value" id="current-ema">--</span>
            </div>
            <div class="price-item">
                <span class="price-label">Position</span>
                <span id="position-tag" class="position-tag tag-neutral">Neutral</span>
            </div>
            <div class="price-item">
                <span class="price-label">Signal</span>
                <span id="signal-tag" class="position-tag tag-neutral">--</span>
            </div>
        </div>

        <!-- Privacy-First Telegram Connection Section -->
        <div class="telegram-section">
            <div class="telegram-header">
                <span class="telegram-icon">ü§ñ</span>
                <div>
                    <div class="telegram-title">Connect via Telegram - 100% Private</div>
                    <div class="telegram-subtitle">Your Chat ID stays on your device. No server storage.</div>
                </div>
            </div>

            <div class="connection-grid">
                <!-- Step 1 -->
                <div class="connection-step">
                    <div class="step-number">1</div>
                    <div class="step-title">Start the Bot</div>
                    <div class="step-description">
                        Click the button below to open Telegram and start a chat with our bot.
                        This establishes a direct connection between you and the bot.
                    </div>
                    <a href="https://t.me/YourTradingBiasBot" target="_blank" class="bot-button">
                        <span>ü§ñ</span> @YourTradingBiasBot
                    </a>
                </div>

                <!-- Step 2 -->
                <div class="connection-step">
                    <div class="step-number">2</div>
                    <div class="step-title">Click "Connect Browser"</div>
                    <div class="step-description">
                        After starting the bot, click the "Connect Browser" button in Telegram.
                        This generates a one-time secure token.
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px;">
                        ü§ñ Bot: Click "Connect Browser" below<br>
                        üîó You'll receive: trading-bias.app/connect?token=xxx
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="connection-step">
                    <div class="step-number">3</div>
                    <div class="step-title">Auto-Connect</div>
                    <div class="step-description">
                        Clicking the link automatically connects this browser to Telegram.
                        Your Chat ID is stored locally and never sent to our servers.
                    </div>
                    <div id="connection-status-display" style="margin-top: 15px;">
                        <div class="connection-status">
                            <span class="status-badge disconnected" id="connection-badge">‚ö´ Disconnected</span>
                            <span class="connection-id" id="connection-id-display">Not connected</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Connection (Optional, for advanced users) -->
            <details style="margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                <summary style="cursor: pointer; color: #FFD700; font-weight: bold;">üîß Manual Connection (Advanced)</summary>
                <div style="margin-top: 15px;">
                    <p style="margin-bottom: 10px; font-size: 14px;">If auto-connect doesn't work, you can manually enter your Chat ID:</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="password" id="manual-chat-id" placeholder="Enter Chat ID" style="padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; flex: 1;">
                        <button id="manual-connect-btn" style="padding: 10px 20px; background: #009688; border: none; border-radius: 8px; color: white; cursor: pointer;">Connect Manually</button>
                        <button id="clear-connection-btn" style="padding: 10px 20px; background: #f44336; border: none; border-radius: 8px; color: white; cursor: pointer;">Clear</button>
                    </div>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px;">
                        ‚ö†Ô∏è Manual entry stores your Chat ID locally only. Never share your Chat ID with anyone.
                    </p>
                </div>
            </details>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('assets')">üìä Market Overview</button>
                <button class="tab-button" onclick="switchTab('timeframes')">üìà Timeframe Analysis</button>
            </div>
            
            <div id="tab-assets" class="tab-content active">
                <div id="multi-asset-dashboard">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <span style="font-size: 18px; font-weight: bold; color: #FFD700;">Multi-Market Dashboard</span>
                            <span style="font-size: 12px; margin-left: 10px; color: rgba(255,255,255,0.6);">EMA <span id="dashboard-ema-period">350</span> ‚Ä¢ <span id="dashboard-threshold">0.1</span>%</span>
                        </div>
                        <span id="dashboard-loading" class="loading-spinner" style="display: none;"></span>
                    </div>
                    <div class="dashboard-grid" id="dashboard-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div style="text-align: right; font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px;" id="dashboard-timestamp">
                        Last updated: --
                    </div>
                </div>
            </div>
            
            <div id="tab-timeframes" class="tab-content">
                <div id="multi-timeframe-dashboard">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <span style="font-size: 18px; font-weight: bold; color: #FFD700;">Multi-Timeframe Analysis</span>
                            <span style="font-size: 12px; margin-left: 10px; color: rgba(255,255,255,0.6);">EMA <span id="mtf-ema-period">350</span> ‚Ä¢ <span id="mtf-threshold">0.1</span>%</span>
                        </div>
                        <span id="mtf-loading" class="loading-spinner" style="display: none;"></span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <select id="mtf-asset-select" style="padding: 8px 15px; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; border: 1px solid #FFD700;">
                            <option value="PAXGUSDT">ü•á PAXG/Gold</option>
                            <option value="ETHUSDT">‚ü† ETH/USDT</option>
                            <option value="BTCUSDT">‚Çø BTC/USDT</option>
                            <option value="XAGUSDT">ü•à XAG/Silver</option>
                            <option value="JPYUSDT">üí¥ JPY/USDT</option>
                            <option value="EURUSDT">üí∂ EUR/USDT</option>
                            <option value="CADUSDT">üíµ CAD/USDT</option>
                            <option value="GBPUSDT">üí∑ GBP/USDT</option>
                        </select>
                        <button onclick="updateMultiTimeframeDashboard()" style="margin-left: 10px; padding: 8px 20px; background: #667eea; border: none; border-radius: 8px; color: white; cursor: pointer;">Refresh</button>
                    </div>

                    <table class="timeframe-table">
                        <thead>
                            <tr>
                                <th>Timeframe</th>
                                <th>Price</th>
                                <th>EMA</th>
                                <th>Position</th>
                                <th>Signal</th>
                            </tr>
                        </thead>
                        <tbody id="timeframe-tbody">
                            <tr><td colspan="5" style="text-align: center;">Select an asset to view analysis</td></tr>
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 10px;" id="mtf-timestamp">
                        Last updated: --
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Controls -->
        <div class="controls">
            <div class="control-group">
                <label>Chart Pair</label>
                <select id="trading-pair">
                    <option value="PAXGUSDT">ü•á PAXG/Gold</option>
                    <option value="ETHUSDT">‚ü† ETH/USDT</option>
                    <option value="BTCUSDT">‚Çø BTC/USDT</option>
                    <option value="XAGUSDT">ü•à XAG/Silver</option>
                    <option value="JPYUSDT">üí¥ JPY/USDT</option>
                    <option value="EURUSDT">üí∂ EUR/USDT</option>
                    <option value="CADUSDT">üíµ CAD/USDT</option>
                    <option value="GBPUSDT">üí∑ GBP/USDT</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Time Frame</label>
                <select id="timeframe">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="1d">1 Day</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>EMA Period</label>
                <input type="number" id="ema-period" value="350" min="1" max="1000">
            </div>
            
            <div class="control-group" style="min-width: 250px;">
                <label>Neutral Threshold <span id="threshold-display">0.10%</span></label>
                <div class="threshold-container">
                    <input type="range" id="threshold-slider" class="threshold-slider" min="0.01" max="2" step="0.01" value="0.1">
                    <span class="threshold-value" id="threshold-value">0.10%</span>
                </div>
            </div>
            
            <div class="control-group">
                <label>Alert Cooldown</label>
                <input type="number" id="alert-cooldown" value="30" min="1" max="300"> sec
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button id="apply-settings">Apply Settings</button>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button id="test-alert">Test Alert</button>
            </div>
            
            <div class="control-group">
                <label>&nbsp;</label>
                <button id="clear-history">Clear History</button>
            </div>
        </div>

        <!-- Chart Container -->
        <div id="chart-container"></div>

        <!-- Signal History -->
        <div style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: bold; color: #FFD700;">Alert History</span>
                <span style="font-size: 12px; color: rgba(255,255,255,0.5;">Local only - cleared with browser data</span>
            </div>
            <div id="signal-history"></div>
        </div>
    </div>

    <script>
        // ============================================
        // PRIVACY-FOCUSED TRADING BIAS MESSENGER
        // Zero-Knowledge Architecture - Chat IDs never leave device
        // ============================================

        // Configuration
        const BOT_USERNAME = 'YourTradingBiasBot'; // Replace with your bot username
        const API_BASE_URL = window.location.origin;

        // Asset lists
        const ALL_ASSETS = ['PAXGUSDT', 'ETHUSDT', 'BTCUSDT', 'XAGUSDT', 'JPYUSDT', 'EURUSDT', 'CADUSDT', 'GBPUSDT'];
        const TIMEFRAMES = ['1m', '5m', '15m', '1h', '1d'];

        // State
        let SYMBOL = 'PAXGUSDT';
        let TF = '1m';
        let EMA_PERIOD = 350;
        let THRESHOLD_PERCENT = 0.1;
        let alertCooldown = 30000;
        let lastAlert = 0;
        
        // Chart variables
        let chart, candlesSeries, emaSeries;
        let socket, rawCandles = [];
        let assetData = {};

        // Telegram state - stored ONLY in localStorage
        let userChatId = localStorage.getItem('tradingBiasChatId') || '';
        let telegramEnabled = !!userChatId;
        let lastTelegramSent = null;

        // Initialize asset data
        ALL_ASSETS.forEach(asset => {
            assetData[asset] = {
                currentPrice: null,
                currentEMA: null,
                position: '--',
                loading: false,
                error: false
            };
        });

        // ============================================
        // PRIVACY-CRITICAL FUNCTIONS
        // No Chat IDs are sent to any server
        // ============================================

        // Check for connection token from Telegram (Step 3)
        function checkForConnectionToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('connect');
            
            if (token) {
                // Decode the token (contains encrypted chat ID)
                try {
                    // Token is base64 encoded: chatId:timestamp
                    const decoded = atob(token);
                    const [chatId, timestamp] = decoded.split(':');
                    
                    // Check if token is fresh (less than 5 minutes old)
                    const tokenAge = Date.now() - parseInt(timestamp);
                    if (tokenAge < 300000) { // 5 minutes
                        // Store chat ID locally - NEVER sent to server
                        localStorage.setItem('tradingBiasChatId', chatId);
                        userChatId = chatId;
                        telegramEnabled = true;
                        
                        // Update UI
                        updateConnectionStatus();
                        
                        // Remove token from URL for security
                        window.history.replaceState({}, document.title, '/');
                        
                        // Send welcome message directly from browser
                        sendDirectTelegramMessage(chatId, 'üîê <b>Browser Connected Successfully!</b>\n\nYour Chat ID is now stored locally on your device. You will receive alerts when price touches the EMA threshold.\n\n<b>Privacy Guarantee:</b> Your Chat ID never leaves your device.');
                        
                        showStatus('‚úÖ Telegram connected successfully!');
                    } else {
                        showStatus('‚ùå Connection token expired. Please try again.');
                    }
                } catch (e) {
                    console.error('Invalid token:', e);
                }
            }
        }

        // Send message directly to Telegram API (browser to Telegram, no server)
        async function sendDirectTelegramMessage(chatId, message) {
            if (!chatId) return false;

            try {
                // Note: In production, you'd want to proxy this through your domain
                // to hide the bot token, but the proxy must NOT log chat IDs
                const response = await fetch(`https://api.telegram.org/bot${window.TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                });

                const data = await response.json();
                
                if (data.ok) {
                    lastTelegramSent = new Date();
                    return true;
                } else {
                    console.error('Telegram error:', data);
                    return false;
                }
            } catch (error) {
                console.error('Failed to send:', error);
                return false;
            }
        }

        // Update connection status in UI
        function updateConnectionStatus() {
            const badge = document.getElementById('connection-badge');
            const idDisplay = document.getElementById('connection-id-display');
            
            if (userChatId) {
                badge.textContent = '‚úÖ Connected';
                badge.className = 'status-badge connected';
                // Only show last 4 digits for privacy
                const maskedId = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + userChatId.slice(-4);
                idDisplay.textContent = `ID: ${maskedId}`;
            } else {
                badge.textContent = '‚ö´ Disconnected';
                badge.className = 'status-badge disconnected';
                idDisplay.textContent = 'Not connected';
            }
        }

        // Manual connection (for advanced users)
        function manualConnect() {
            const chatId = document.getElementById('manual-chat-id').value.trim();
            
            if (chatId && /^\d+$/.test(chatId)) { // Basic validation
                localStorage.setItem('tradingBiasChatId', chatId);
                userChatId = chatId;
                telegramEnabled = true;
                updateConnectionStatus();
                document.getElementById('manual-chat-id').value = '';
                showStatus('‚úÖ Chat ID saved locally');
                
                // Send verification
                sendDirectTelegramMessage(chatId, 'üîê <b>Manual Connection Successful</b>\n\nYour Chat ID is now stored locally on your device.');
            } else {
                alert('Please enter a valid numeric Chat ID');
            }
        }

        // Clear connection
        function clearConnection() {
            localStorage.removeItem('tradingBiasChatId');
            userChatId = '';
            telegramEnabled = false;
            updateConnectionStatus();
            showStatus('üîì Connection cleared from device');
        }

        // ============================================
        // TRADING FUNCTIONS (Unchanged from original)
        // ============================================

        function getPairDisplayName(symbol) {
            const names = {
                'PAXGUSDT': 'ü•á PAXG/Gold',
                'ETHUSDT': '‚ü† ETH/USDT',
                'BTCUSDT': '‚Çø BTC/USDT',
                'XAGUSDT': 'ü•à XAG/Silver',
                'JPYUSDT': 'üí¥ JPY/USDT',
                'EURUSDT': 'üí∂ EUR/USDT',
                'CADUSDT': 'üíµ CAD/USDT',
                'GBPUSDT': 'üí∑ GBP/USDT'
            };
            return names[symbol] || symbol;
        }

        function formatPrice(price, symbol = SYMBOL) {
            if (!price || isNaN(price)) return '--';
            
            if (symbol.includes('BTC')) return price.toFixed(1);
            if (symbol.includes('JPY')) return price.toFixed(3);
            if (symbol.includes('XAG') || symbol.includes('PAXG') || 
                symbol.includes('EUR') || symbol.includes('GBP') || 
                symbol.includes('CAD')) return price.toFixed(4);
            return price.toFixed(2);
        }

        function determinePosition(price, ema) {
            if (!price || !ema) return '--';
            
            const percentDiff = Math.abs((price - ema) / ema) * 100;
            
            if (percentDiff <= THRESHOLD_PERCENT) return 'AT';
            return price > ema ? 'ABOVE' : 'BELOW';
        }

        async function fetchWithFallback(asset, interval, limit) {
            try {
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${asset}&interval=${interval}&limit=${limit}`);
                if (response.ok) {
                    const data = await response.json();
                    return { data, source: 'Binance' };
                }
                throw new Error('Binance failed');
            } catch (error) {
                // Return simulated data for demo
                return { data: generateSimulatedData(asset, interval, limit), source: 'Demo' };
            }
        }

        function generateSimulatedData(asset, interval, limit) {
            const data = [];
            const now = Date.now();
            const basePrice = {
                'PAXGUSDT': 2000, 'ETHUSDT': 3000, 'BTCUSDT': 50000,
                'XAGUSDT': 25, 'JPYUSDT': 0.0067, 'EURUSDT': 1.08,
                'CADUSDT': 0.74, 'GBPUSDT': 1.26
            }[asset] || 100;

            for (let i = limit; i > 0; i--) {
                const time = now - (i * getIntervalMs(interval));
                const change = (Math.random() - 0.5) * 0.02;
                const open = basePrice * (1 + (Math.random() - 0.5) * 0.02);
                const close = open * (1 + change);
                const high = Math.max(open, close) * (1 + Math.random() * 0.01);
                const low = Math.min(open, close) * (1 - Math.random() * 0.01);
                
                data.push([time, open.toString(), high.toString(), low.toString(), close.toString()]);
            }
            return data;
        }

        function getIntervalMs(interval) {
            const ms = { '1m': 60000, '5m': 300000, '15m': 900000, '1h': 3600000, '1d': 86400000 };
            return ms[interval] || 60000;
        }

        function calculateEMA(prices, period) {
            const k = 2 / (period + 1);
            const ema = [];
            let sum = prices.slice(0, period).reduce((a, b) => a + b, 0);
            ema[period - 1] = sum / period;
            
            for (let i = period; i < prices.length; i++) {
                ema[i] = prices[i] * k + ema[i - 1] * (1 - k);
            }
            return ema.slice(period - 1);
        }

        // ============================================
        // UI UPDATES
        // ============================================

        function showStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function updatePriceSummary() {
            if (rawCandles.length === 0) return;
            
            const currentCandle = rawCandles[rawCandles.length - 1];
            const currentPrice = currentCandle.close;
            
            let currentEMA = null;
            if (rawCandles.length >= EMA_PERIOD) {
                const closes = rawCandles.map(c => c.close);
                const emaValues = calculateEMA(closes, EMA_PERIOD);
                currentEMA = emaValues[emaValues.length - 1];
            }
            
            document.getElementById('current-asset').textContent = getPairDisplayName(SYMBOL);
            document.getElementById('current-price').textContent = '$' + formatPrice(currentPrice);
            document.getElementById('ema-period-display').textContent = EMA_PERIOD;
            
            if (currentEMA !== null) {
                document.getElementById('current-ema').textContent = '$' + formatPrice(currentEMA);
                
                const position = determinePosition(currentPrice, currentEMA);
                const positionTag = document.getElementById('position-tag');
                const signalTag = document.getElementById('signal-tag');
                
                if (position === 'AT') {
                    positionTag.textContent = 'AT EMA';
                    positionTag.className = 'position-tag tag-neutral';
                    signalTag.textContent = 'NEUTRAL';
                    signalTag.className = 'position-tag tag-neutral';
                } else if (position === 'ABOVE') {
                    positionTag.textContent = 'ABOVE EMA';
                    positionTag.className = 'position-tag tag-bullish';
                    signalTag.textContent = 'BULLISH';
                    signalTag.className = 'position-tag tag-bullish';
                } else {
                    positionTag.textContent = 'BELOW EMA';
                    positionTag.className = 'position-tag tag-bearish';
                    signalTag.textContent = 'BEARISH';
                    signalTag.className = 'position-tag tag-bearish';
                }
            }
        }

        async function updateDashboard() {
            const grid = document.getElementById('dashboard-grid');
            const loading = document.getElementById('dashboard-loading');
            
            loading.style.display = 'inline-block';
            document.getElementById('dashboard-ema-period').textContent = EMA_PERIOD;
            document.getElementById('dashboard-threshold').textContent = THRESHOLD_PERCENT;
            
            const promises = ALL_ASSETS.map(async (asset) => {
                try {
                    assetData[asset].loading = true;
                    
                    const limit = Math.max(100, EMA_PERIOD + 20);
                    const result = await fetchWithFallback(asset, TF, limit);
                    
                    const candles = result.data.map(r => ({ close: parseFloat(r[4]) }));
                    const currentPrice = parseFloat(result.data[result.data.length - 1][4]);
                    
                    let currentEMA = null;
                    let position = '--';
                    
                    if (candles.length >= EMA_PERIOD) {
                        const closes = candles.map(c => c.close);
                        const emaValues = calculateEMA(closes, EMA_PERIOD);
                        currentEMA = emaValues[emaValues.length - 1];
                        position = determinePosition(currentPrice, currentEMA);
                    }
                    
                    assetData[asset] = {
                        currentPrice,
                        currentEMA,
                        position,
                        loading: false,
                        error: false
                    };
                    
                } catch (error) {
                    assetData[asset] = {
                        loading: false,
                        error: true,
                        position: 'ERROR'
                    };
                }
            });
            
            await Promise.all(promises);
            
            // Render dashboard
            grid.innerHTML = '';
            ALL_ASSETS.forEach(asset => {
                const data = assetData[asset];
                const displayName = getPairDisplayName(asset);
                
                let cardClass = 'asset-card';
                let positionClass = 'tag-neutral';
                let positionText = 'Loading...';
                
                if (!data.loading) {
                    if (data.error) {
                        positionText = 'Error';
                    } else if (data.position === 'ABOVE') {
                        positionClass = 'tag-bullish';
                        positionText = 'BULLISH';
                        cardClass += ' bullish';
                    } else if (data.position === 'BELOW') {
                        positionClass = 'tag-bearish';
                        positionText = 'BEARISH';
                        cardClass += ' bearish';
                    } else if (data.position === 'AT') {
                        positionClass = 'tag-neutral';
                        positionText = 'NEUTRAL';
                        cardClass += ' neutral';
                    }
                }
                
                const priceDisplay = data.currentPrice ? '$' + formatPrice(data.currentPrice, asset) : '--';
                const emaDisplay = data.currentEMA ? '$' + formatPrice(data.currentEMA, asset) : '--';
                
                grid.innerHTML += `
                    <div class="${cardClass}">
                        <div class="asset-header">
                            <span class="asset-name">${displayName}</span>
                            <span class="asset-price">${priceDisplay}</span>
                        </div>
                        <div class="asset-details">
                            <span class="asset-ema">EMA: ${emaDisplay}</span>
                            <span class="asset-position ${positionClass}">${positionText}</span>
                        </div>
                    </div>
                `;
            });
            
            loading.style.display = 'none';
            document.getElementById('dashboard-timestamp').textContent = 
                `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        async function updateMultiTimeframeDashboard() {
            const asset = document.getElementById('mtf-asset-select').value;
            const tbody = document.getElementById('timeframe-tbody');
            const loading = document.getElementById('mtf-loading');
            
            loading.style.display = 'inline-block';
            document.getElementById('mtf-ema-period').textContent = EMA_PERIOD;
            document.getElementById('mtf-threshold').textContent = THRESHOLD_PERCENT;
            
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;"><span class="loading-spinner"></span> Loading...</td></tr>';
            
            try {
                const rows = [];
                
                for (const tf of TIMEFRAMES) {
                    const limit = Math.max(100, EMA_PERIOD + 20);
                    const result = await fetchWithFallback(asset, tf, limit);
                    
                    const currentPrice = parseFloat(result.data[result.data.length - 1][4]);
                    const closes = result.data.map(r => parseFloat(r[4]));
                    
                    let currentEMA = null;
                    let position = '--';
                    let signal = '--';
                    let positionClass = 'tag-neutral';
                    
                    if (closes.length >= EMA_PERIOD) {
                        const emaValues = calculateEMA(closes, EMA_PERIOD);
                        currentEMA = emaValues[emaValues.length - 1];
                        position = determinePosition(currentPrice, currentEMA);
                        
                        if (position === 'AT') {
                            signal = 'NEUTRAL';
                            positionClass = 'tag-neutral';
                        } else if (position === 'ABOVE') {
                            signal = 'BULLISH';
                            positionClass = 'tag-bullish';
                        } else {
                            signal = 'BEARISH';
                            positionClass = 'tag-bearish';
                        }
                    }
                    
                    rows.push({
                        tf,
                        price: '$' + formatPrice(currentPrice, asset),
                        ema: currentEMA ? '$' + formatPrice(currentEMA, asset) : '--',
                        signal,
                        positionClass
                    });
                }
                
                const tfOrder = { '1m': 1, '5m': 2, '15m': 3, '1h': 4, '1d': 5 };
                rows.sort((a, b) => tfOrder[a.tf] - tfOrder[b.tf]);
                
                tbody.innerHTML = rows.map(row => `
                    <tr>
                        <td><strong>${row.tf}</strong></td>
                        <td>${row.price}</td>
                        <td>${row.ema}</td>
                        <td>${row.signal}</td>
                        <td><span class="timeframe-badge ${row.positionClass}">${row.signal}</span></td>
                    </tr>
                `).join('');
                
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #f44336;">Error loading data</td></tr>';
            }
            
            loading.style.display = 'none';
            document.getElementById('mtf-timestamp').textContent = 
                `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        // ============================================
        // CHART FUNCTIONS
        // ============================================

        async function loadData() {
            showStatus('Loading data...');
            try {
                const limit = Math.max(100, EMA_PERIOD + 50);
                const result = await fetchWithFallback(SYMBOL, TF, limit);
                
                rawCandles = result.data.map(r => ({
                    time: r[0] / 1000,
                    open: parseFloat(r[1]),
                    high: parseFloat(r[2]),
                    low: parseFloat(r[3]),
                    close: parseFloat(r[4])
                }));
                
                candlesSeries.setData(rawCandles);
                plotEMA();
                updatePriceSummary();
                showStatus(`Loaded ${rawCandles.length} candles`);
            } catch (e) {
                showStatus('Error loading data');
            }
        }

        function plotEMA() {
            if (rawCandles.length < EMA_PERIOD) return;
            
            const closes = rawCandles.map(c => c.close);
            const ema = calculateEMA(closes, EMA_PERIOD);
            const emaData = rawCandles.slice(EMA_PERIOD - 1).map((c, i) => ({
                time: c.time,
                value: ema[i]
            }));
            
            emaSeries.setData(emaData);
        }

        function initWS() {
            if (socket) socket.close();
            
            TF = document.getElementById('timeframe').value;
            
            try {
                socket = new WebSocket(`wss://stream.binance.com:9443/ws/${SYMBOL.toLowerCase()}@kline_${TF}`);
                
                socket.onmessage = (e) => {
                    const m = JSON.parse(e.data);
                    if (!m.k) return;
                    
                    const k = m.k;
                    const c = {
                        time: k.t / 1000,
                        open: parseFloat(k.o),
                        high: parseFloat(k.h),
                        low: parseFloat(k.l),
                        close: parseFloat(k.c)
                    };
                    
                    if (k.x) {
                        rawCandles.push(c);
                        const maxCandles = 500;
                        if (rawCandles.length > maxCandles) rawCandles.shift();
                        candlesSeries.update(c);
                        plotEMA();
                        checkEMAAlert();
                    } else {
                        candlesSeries.update(c);
                    }
                    updatePriceSummary();
                };
            } catch (e) {
                console.warn('WebSocket failed, using REST polling');
                setInterval(async () => {
                    await loadData();
                }, 60000);
            }
        }

        // ============================================
        // ALERT FUNCTIONS
        // ============================================

        async function checkEMAAlert() {
            const now = Date.now();
            if (now - lastAlert < alertCooldown) return;
            if (rawCandles.length < EMA_PERIOD) return;

            const currentCandle = rawCandles[rawCandles.length - 1];
            const closes = rawCandles.map(c => c.close);
            const currentEMA = calculateEMA(closes, EMA_PERIOD).pop();
            
            const percentDiff = Math.abs((currentCandle.close - currentEMA) / currentEMA) * 100;
            
            if (percentDiff <= THRESHOLD_PERCENT) {
                handleAlert('Price touched EMA', currentCandle.close, currentEMA);
                
                // Send Telegram alert directly from browser (if connected)
                if (userChatId) {
                    const message = `
üì® <b>TRADING BIAS ALERT</b>

üìä ${getPairDisplayName(SYMBOL)}
üí∞ Price: $${formatPrice(currentCandle.close)}
üìà EMA(${EMA_PERIOD}): $${formatPrice(currentEMA)}
‚ö°Ô∏è Threshold: ${THRESHOLD_PERCENT}%
‚è±Ô∏è Timeframe: ${TF}

<i>Price is within ${THRESHOLD_PERCENT}% of EMA</i>

üîê <i>Sent directly from your browser</i>
                    `;
                    
                    await sendDirectTelegramMessage(userChatId, message);
                }
                
                lastAlert = now;
            }
        }

        function handleAlert(msg, price, ema) {
            playBeep();
            
            const entry = {
                time: new Date().toLocaleTimeString(),
                text: `${new Date().toLocaleTimeString()} - ${getPairDisplayName(SYMBOL)} - ${msg} | Price: $${formatPrice(price)} | EMA: $${formatPrice(ema)}`
            };
            
            const history = document.getElementById('signal-history');
            const div = document.createElement('div');
            div.className = 'alert-touch';
            div.textContent = entry.text;
            history.insertBefore(div, history.firstChild);
            
            if (history.children.length > 100) {
                history.removeChild(history.lastChild);
            }
            
            // Store in localStorage
            let alerts = JSON.parse(localStorage.getItem('alertHistory') || '[]');
            alerts.unshift(entry);
            if (alerts.length > 100) alerts = alerts.slice(0, 100);
            localStorage.setItem('alertHistory', JSON.stringify(alerts));
        }

        function playBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 800;
                gain.gain.value = 0.1;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) {
                console.error('Audio error:', e);
            }
        }

        function testAlert() {
            if (rawCandles.length === 0) {
                alert('Please wait for data to load');
                return;
            }
            
            const testPrice = rawCandles[rawCandles.length - 1].close;
            const testEMA = rawCandles.length >= EMA_PERIOD ?
                calculateEMA(rawCandles.map(c => c.close), EMA_PERIOD).pop() :
                testPrice * 0.99;
            
            handleAlert('TEST ALERT', testPrice, testEMA);
            
            // Test Telegram if connected
            if (userChatId) {
                sendDirectTelegramMessage(userChatId, 'üîî <b>Test Alert</b>\n\nYour Telegram connection is working!');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            // Check for connection token from Telegram
            checkForConnectionToken();
            
            // Set bot token from environment (injected by Vercel)
            // This is the only server-known secret, but it's necessary for Telegram API
            window.TELEGRAM_BOT_TOKEN = 'YOUR_BOT_TOKEN'; // Will be replaced by build process
            
            // Setup event listeners
            document.getElementById('apply-settings').addEventListener('click', applySettings);
            document.getElementById('test-alert').addEventListener('click', testAlert);
            document.getElementById('clear-history').addEventListener('click', clearHistory);
            document.getElementById('trading-pair').addEventListener('change', changePair);
            document.getElementById('timeframe').addEventListener('change', applySettings);
            document.getElementById('manual-connect-btn').addEventListener('click', manualConnect);
            document.getElementById('clear-connection-btn').addEventListener('click', clearConnection);
            
            // Threshold slider
            const slider = document.getElementById('threshold-slider');
            slider.addEventListener('input', function() {
                const val = parseFloat(this.value).toFixed(2);
                document.getElementById('threshold-value').textContent = val + '%';
                document.getElementById('threshold-display').textContent = val + '%';
                THRESHOLD_PERCENT = parseFloat(val);
            });

            // Initialize chart
            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: '#1a1a2e',
                    textColor: 'rgba(255,255,255,0.9)'
                },
                grid: {
                    vertLines: { color: 'rgba(255,255,255,0.1)' },
                    horzLines: { color: 'rgba(255,255,255,0.1)' }
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false
                }
            });

            candlesSeries = chart.addCandlestickSeries({
                upColor: '#4CAF50',
                downColor: '#f44336',
                borderVisible: false,
                wickUpColor: '#4CAF50',
                wickDownColor: '#f44336'
            });

            emaSeries = chart.addLineSeries({ color: '#FFD700', lineWidth: 2 });

            // Load data
            loadData().then(initWS);
            
            // Load alert history
            const alerts = JSON.parse(localStorage.getItem('alertHistory') || '[]');
            alerts.forEach(alert => {
                const div = document.createElement('div');
                div.className = 'alert-touch';
                div.textContent = alert.text;
                document.getElementById('signal-history').appendChild(div);
            });

            // Update UI
            updateConnectionStatus();
            updateDashboard();
            
            // Start timers
            startTimer();
            setInterval(updatePriceSummary, 1000);
            setInterval(updateDashboard, 30000);
        }

        function startTimer() {
            setInterval(() => {
                const timeframe = document.getElementById('timeframe').value;
                const now = new Date();
                let nextClose;
                
                switch(timeframe) {
                    case '1m':
                        nextClose = new Date(now);
                        nextClose.setSeconds(0);
                        nextClose.setMinutes(nextClose.getMinutes() + 1);
                        break;
                    case '5m':
                        nextClose = new Date(now);
                        nextClose.setSeconds(0);
                        nextClose.setMinutes(Math.floor(now.getMinutes() / 5) * 5 + 5);
                        break;
                    case '15m':
                        nextClose = new Date(now);
                        nextClose.setSeconds(0);
                        nextClose.setMinutes(Math.floor(now.getMinutes() / 15) * 15 + 15);
                        break;
                    case '1h':
                        nextClose = new Date(now);
                        nextClose.setSeconds(0);
                        nextClose.setMinutes(0);
                        nextClose.setHours(nextClose.getHours() + 1);
                        break;
                    case '1d':
                        nextClose = new Date(now);
                        nextClose.setHours(0, 0, 0, 0);
                        nextClose.setDate(nextClose.getDate() + 1);
                        break;
                }
                
                const diff = nextClose - now;
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                document.getElementById('next-candle-timer').textContent = 
                    `Next candle: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function changePair() {
            const newSymbol = document.getElementById('trading-pair').value;
            if (newSymbol !== SYMBOL) {
                SYMBOL = newSymbol;
                rawCandles = [];
                if (socket) socket.close();
                loadData().then(initWS);
            }
        }

        function applySettings() {
            const newTimeframe = document.getElementById('timeframe').value;
            const newEMAPeriod = parseInt(document.getElementById('ema-period').value);
            const newCooldown = parseInt(document.getElementById('alert-cooldown').value) * 1000;
            
            const timeframeChanged = newTimeframe !== TF;
            
            EMA_PERIOD = newEMAPeriod;
            alertCooldown = newCooldown;
            
            if (timeframeChanged) {
                TF = newTimeframe;
                rawCandles = [];
                if (socket) socket.close();
                loadData().then(initWS);
            } else {
                plotEMA();
            }
            
            updatePriceSummary();
            updateDashboard();
            updateMultiTimeframeDashboard();
            
            showStatus(`Settings applied - Threshold: ${THRESHOLD_PERCENT}%`);
        }

        function clearHistory() {
            if (confirm('Clear alert history?')) {
                localStorage.removeItem('alertHistory');
                document.getElementById('signal-history').innerHTML = '';
                showStatus('History cleared');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'assets') {
                document.querySelector('.tab-button').classList.add('active');
                document.getElementById('tab-assets').classList.add('active');
            } else {
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                document.getElementById('tab-timeframes').classList.add('active');
                updateMultiTimeframeDashboard();
            }
        }

        // Start the app
        window.onload = init;
    </script>
</body>
</html>
